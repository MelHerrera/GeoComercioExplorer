{% extends "base.html" %}

{% block content %}
{% load static %}

<style>
  #folium_map {
      width: 100%;
  }
</style>

<div class="container mt-3">
    <div class="row">
      <div class="col-3">
        <div class="nav flex-column nav-pills" id="v-pills-tab" role="tablist" aria-orientation="vertical">
          <a class="nav-link active" id="v-pills-home-tab" data-toggle="pill" href="#v-pills-home" role="tab" aria-controls="v-pills-home" aria-selected="true">
            <i class="bi bi-house"></i>
            Dashboard
        </a>
          <a class="nav-link" id="v-pills-profile-tab" data-toggle="pill" href="#v-pills-profile" role="tab" aria-controls="v-pills-profile" aria-selected="false">
            <i class="bi bi-clipboard2-data"></i>
            GeoComerce
        </a>
          <a class="nav-link" id="v-pills-settings-tab" data-toggle="pill" href="#v-pills-settings" role="tab" aria-controls="v-pills-settings" aria-selected="false">
            <i class="bi bi-sliders"></i>
            Configuración
        </a>
        </div>
      </div>
      <div class="col-6">
        <div class="tab-content" id="v-pills-tabContent">
          <div class="tab-pane fade show active" id="v-pills-home" role="tabpanel" aria-labelledby="v-pills-home-tab">

                    <table class="table">
                        <thead class="bg-primary text-white">
                          <tr>
                            <th scope="col">Código</th>
                            <th scope="col">Latitud</th>
                            <th scope="col">Longitud</th>
                            <th scope="col">Estado</th>
                          </tr>
                        </thead>
                        <tbody>
                            {% for row in top_5_data %}
                            <tr>
                                <td>{{ row.d_codigo }}</td>
                                <td>{{ row.Latitud }}</td>
                                <td>{{ row.Longitud }}</td>
                                <td>{{ row.c_estado }}</td>
                            <tr>
                            {% endfor %}
                        </tbody>
                      </table>


        </div>
          <div class="tab-pane fade" id="v-pills-profile" role="tabpanel" aria-labelledby="v-pills-profile-tab">
            <form>
                <div class="row">
                    <div class="col-4">
                        <div class="form-group">
                            <label for="InputCodigo" class="font-weight-bold">Código Postal</label>
                            <input type="text" class="form-control" id="InputCodigo" value="01000">
                        </div>
                    </div>
                    <div class="col-8">
                      <div class="form-group">
                        <label for="formControlRange" class="font-weight-bold" id="formControlRangeLabel" >Distancia(Km): 10</label>
                        <input type="range" class="form-control-range custom-range" id="formControlRange" value="10" min="1" max="20">
                      </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12">
                        <div class="form-group">
                            <label for="FormControlSelectActividad" class="font-weight-bold">Actividad Economica</label>
                            <input type="text" class="form-control" id="FormControlSelectActividad" value="michoacana">
                          </div>
                    </div>
                </div>
                <row>
                  <div class="col">
                    <div id="folium_map">
                      {{ map_html|safe }}
                    </div>
                  </div>
                </row>
            </form>
          </div>
          <div class="tab-pane fade" id="v-pills-settings" role="tabpanel" aria-labelledby="v-pills-settings-tab">
            Settings content...
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.getElementById('formControlRange').addEventListener('input', function () {
      document.getElementById('formControlRangeLabel').textContent = "Distancia(Km): " + this.value;
    });

    var codigoPostal = document.getElementById('InputCodigo')
    console.log("Codigo: " + codigoPostal.value);

    document.getElementById('InputCodigo').addEventListener('input', function () {
      console.log("Codigo: " + this.value);
    });

    document.getElementById('FormControlSelectActividad').addEventListener('input', function () {
      console.log("Actividad economica:" + this.value);
    });

  window.addEventListener('load', () => {
    getActividadesEconomicas();
  });

  function getActividadesEconomicas(){
    var codigoPostal = document.getElementById('InputCodigo')?.value
    var radio = document.getElementById('formControlRange')?.value
    var actividad_to_search = document.getElementById('FormControlSelectActividad')?.value

    fetch(`/get_actividades/${codigoPostal}/${radio}/${actividad_to_search}`)
            .then(response => response.json())
            .then(data => {
                console.log(data);
                document.getElementById('folium_map').innerHTML = data.map_html; //Folium
                // loadGoogleMapsScript(() => {
                //   iniciarMap("folium_map",data.map_html.markers_comercios,data.map_html.markers_competencia, data.map_html.markers_comercios_radio, data.map_html.lat1, data.map_html.lon1, radio );
                // });
                console.log(data)
            })
            .catch(error => {
                console.error('Error fetching data:', error);
            });
  }

  function loadGoogleMapsScript(callback) {
            var script = document.createElement('script');
            script.src = "https://maps.googleapis.com/maps/api/js?key=AIzaSyANc8ljgqQMKc12NVrtzDqGw8mNyiP8PD0";
            script.async = true;
            script.onload = callback;
            document.head.appendChild(script);
        }

  function iniciarMap(templateid, m_comercios, m_competencia, m_comercios, lat1, lon1,distancia_km) {  
    // Coordenadas para los comercios buscados
    var locationsGroup1 = JSON.parse(m_comercios);

    // Coordenadas para los comercios de la competencia
    var locationsGroup2 = JSON.parse(m_competencia);

    // Coordenadas de los códigos postales involucrados en el radio de búsqueda
    var locationsGroupCP = JSON.parse(m_comercios);

    // Crear el mapa centrado en el código postal proporcionado
    var map = new google.maps.Map(document.getElementById(templateid), { 
        zoom: 15, 
        center: {lat: lat1, lng: lon1}
    });

    // Añadir múltiples marcadores para los comercios buscados
    locationsGroup1.forEach(function(location) { 
        var marker = new google.maps.Marker({ 
            position: {lat: location.lat, lng: location.lng}, 
            map: map, 
            title: 'CP ' + location.label + '\n' + location.title,  
            label: { 
                text: location.title, 
                color: 'blue', 
                fontSize: '10px', 
                fontWeight: 'bold' 
            }, 
            icon: { 
                url: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png', 
                scaledSize: new google.maps.Size(50, 50), // Escalar el tamaño del icono 
                origin: new google.maps.Point(0, 0), // Origen del icono 
                anchor: new google.maps.Point(25, 50) // Punto de anclaje del icono 
            }, 
            draggable: true,
            animation: google.maps.Animation.DROP,
            visible: true,
            zIndex: 1,
            clickable: true,
            optimized: false
        });

        // Añadir un evento para manejar el clic en el marcador
        marker.addListener('click', function() {
            alert(location.title);
        });
    });

    // Añadir múltiples marcadores para la competencia
    locationsGroup2.forEach(function(location) { 
        var marker = new google.maps.Marker({ 
            position: {lat: location.lat, lng: location.lng}, 
            map: map, 
            title: 'CP ' + location.label + '\n' + location.title,  
            label: { 
                text: 'Competencia',  
                color: 'red', 
                fontSize: '10px', 
                fontWeight: 'bold' 
            }, 
            icon: { 
                url: 'http://maps.google.com/mapfiles/ms/icons/red-dot.png', 
                scaledSize: new google.maps.Size(40, 40), // Escalar el tamaño del icono 
                origin: new google.maps.Point(0, 0), // Origen del icono 
                anchor: new google.maps.Point(25, 50) // Punto de anclaje del icono 
            }, 
            draggable: true,
            animation: google.maps.Animation.DROP,
            visible: true,
            zIndex: 1,
            clickable: true,
            optimized: false
        });

        // Añadir un evento para manejar el clic en el marcador
        marker.addListener('click', function() {
            alert(location.title);
        });
    });

    // Añadir múltiples marcadores para los códigos postales involucrados en el radio de búsqueda
    locationsGroupCP.forEach(function(location) {   
        var marker = new google.maps.Marker({  
            position: {lat: location.lat, lng: location.lng},  
            map: map,  
            title: location.title,   
            label: {  
                text: location.title,  
                color: 'black',  
                fontSize: '12px',  
                fontWeight: 'bold'  
            },  
            icon: {  
                url:  'http://maps.google.com/mapfiles/ms/icons/yellow-dot.png',  
                scaledSize: new google.maps.Size(40, 40), // Escalar el tamaño del icono  
                origin: new google.maps.Point(0, 0), // Origen del icono  
                anchor: new google.maps.Point(25, 50) // Punto de anclaje del icono   
            },  
            draggable: true,  
            animation: google.maps.Animation.DROP, 
            visible: true, 
            zIndex: 1, 
            clickable: true, 
            optimized: false 
        }); 

        // Añadir un evento para manejar el clic en el marcador 
        marker.addListener('click', function() { 
            alert(location.title); 
        }); 
    });

    // Crear el círculo con el CP buscado y la distancia de búsqueda
    var circleOptions = {
        strokeColor: '#FF0000', 
        strokeOpacity: 0.8, 
        strokeWeight: 2, 
        fillColor: '#FF0000', 
        fillOpacity: 0.1,  
        map: map,  
        center: {lat: lat1, lng: lon1}, // Coordenadas del centro del círculo  
        radius: distancia_km * 1000 // Radio en metros
    };

    // Crear el círculo y añadirlo al mapa
    var cityCircle = new google.maps.Circle(circleOptions);

    // Añadir múltiples círculos con los códigos postales involucrados. Se asume 1 km de radio de CP
    locationsGroupCP.forEach(function(location) {  
        var cityCircle = new google.maps.Circle({  
            strokeColor: '#FF0000',  
            strokeOpacity: 0.3,  
            strokeWeight: 2,  
            fillColor: '#FFFF00',  
            fillOpacity: 0.1,   
            map: map,   
            center:  {lat: location.lat, lng: location.lng}, // Coordenadas del centro del círculo   
            radius: 1000.0 // Radio en metros   
        }); 
    });
}

  </script>
    <!-- <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyANc8ljgqQMKc12NVrtzDqGw8mNyiP8PD0&loading=async&callback=initMap"></script> -->

{% endblock %}